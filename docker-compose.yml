version: '3'

services:
  db:
    image: postgres:13
    container_name: nextcloud-postgres
    volumes:
      - ./db-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      - POSTGRES_PASSWORD=${NEXTCLOUD_PG_PASSWORD}
    restart: unless-stopped
    networks:
      - default

  app:
    image: nextcloud:latest
    container_name: nextcloud-app
    depends_on:
      - db
    volumes:
      - ./nextcloud:/var/www/html
      - ./app/config:/var/www/html/config
      - ./app/custom_apps:/var/www/html/custom_apps
      - ./app/data:/var/www/html/data
      - ./app/themes:/var/www/html/themes
      - /etc/localtime:/etc/localtime
      - /mnt/backup:/mnt/backup
      - /mnt/media:/mnt/media
    environment:
      - VIRTUAL_HOST=${EXTERNAL_URL}
      - OVERWRITECLIURL=https://nextcloud.${EXTERNAL_URL}
      - OVERWRITEPROTOCOL=https
      - LETSENCRYPT_HOST=${EXTERNAL_URL}
      - LETSENCRYPT_EMAIL=${EMAIL}
      - NEXTCLOUD_HOSTNAME='My cloud'
      - NEXTCLOUD_TRUSTED_DOMAINS=https://nextcloud.${EXTERNAL_URL}
      - REDIS_HOST=redis
    restart: unless-stopped
    networks:
      - default

  redis:
    image: redis:alpine
    container_name: nextcloud-redis
    volumes:
      - ./config_redis:/data
    restart: unless-stopped
    networks:
      - default

  syncthing:
    image: lscr.io/linuxserver/syncthing:latest
    container_name: syncthing
    hostname: syncthing
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - ./config_syncthing:/config
      - /mnt/backup:/mnt/backup
    # ports:
    #   - 8384:8384 # Web UI
    #   - 22000:22000/tcp # TCP file transfers
    #   - 22000:22000/udp # QUIC file transfers
    #   - 21027:21027/udp # Receive local discovery broadcasts
    restart: unless-stopped
    networks:
      - default

networks:
  default:
    external: true
    name: volokzhanin
